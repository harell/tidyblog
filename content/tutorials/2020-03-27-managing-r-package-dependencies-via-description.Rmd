---
title: "Managing R Package Dependencies"
description: "The R equivalent of requirements.txt in Python"
author: "Harel Lustiger"
date: '2020-03-27'
draft: yes
categories:
- R Projects
- Reproducible Research
slug: managing-r-package-dependencies-via-description
tags:
- Package Management    
- Reproducible Research    
- DESCRIPTION
link-citations: yes 
bibliography: [references-posts.bib]
biblio-style: harvard1.csl
---

The dependency of an R project on R packages makes both the R user and the R
developer lives difficult.

Making an R project work on a different computer requires the installation of
many R packages. This also holds when running an R project on the same computer
after a major R version upgrade.

On a granular level, an **R project is dependent on functions within R
packages**. One would assume that a newer version of a package would be backward
compatible. In practice, newer versions may remove functions and may contain
changes that lead to different outcomes. Thus, installing different packages
versions than those used during the development of the R project may lead to
different outcomes or an execution error.

*Dependency management systems* help tracing, registering and installing
packages dependencies for a particular R project. Using a dependency management
system is essential for ensuring reproducible results and seamless collaboration
within a team of developers.

The dependency management system described here is simple and fits most
applications. It may serve as the bedrock of more sophisticated systems when
further needs arise.

# Overview

The approach in a nutshell:

1. Maintaining package requirements in a `DESCRIPTION` file; 
2. Setting the URL from which to pull the packages from via `repos`; and
3. Installing all required packages with `remotes::install_deps()`.

If you need a solution quickly, jump to 
["Putting Everything Together"](#conclusion) section to see code for a working
example.

<!-- talk about addind the dplyr package as a dependecncy -->

<!-- what is a dependency -->

# Introduction

## Understanding the principles of package management

<!-- theory -->

## Understanding the underline mechanism of package managers in R

<!-- * install.packages() -->

## Writing R Extensions

The package management system proposed here adheres to the _Writing R
Extensions_ guide [@team1999writing, ch. 1] which describes the process of
creating R packages. There are two relevant sections in the guide for managing
package dependencies: _The DESCRIPTION file_ and _Package Dependencies_.

<!-- The DESCRIPTION file -->

<!-- Package Dependencies -->

## Using a de-jure Package Manager

<!-- Main feature -->

<!-- Advantages -->

# Managing R Packages via DESCRIPTION {#recipe}

## Getting Started

The dependency management system calls for three ingredients:

* The [`remotes`](https://github.com/r-lib/remotes) package;
* The [`usethis`](https://github.com/r-lib/usethis/) package; and
* A `DESCRIPTION` file.

You can install both packages at once by running:

```{r, echo = TRUE, eval = FALSE}
install.packages(c("remotes", "usethis"))
```

You can create a new `DESCRIPTION` file by running:

```{r, echo = TRUE, eval = FALSE}
usethis::use_description()
```

The last command saves a `DESCRIPTION` skeleton at the working directory with
the following content:

```
Package: project.name
Title: What the Package Does (One Line, Title Case)
Version: 0.0.0.9000
Authors@R: 
    person(given = "First",
           family = "Last",
           role = c("aut", "cre"),
           email = "first.last@example.com",
           comment = c(ORCID = "YOUR-ORCID-ID"))
Description: What the package does (one paragraph).
License: What license it uses
Encoding: UTF-8
LazyData: true
```

`DESCRIPTION` uses an archaic file format called DCF (Debian control format)
which was available during R inception. DCF is somewhat similar to YAML in its
structure. Each line consists of a **field** name paired with one or more
**values** separated by a colon. When values span multiple lines, they need to
be indented by four spaces.

Package management in R is done primarily through assigning packages names to
the `Imports` field which we handle next.

## Grooming the DESCRIPTION file 

### Adding package requirements from CRAN

As the R application evolves, anytime an additional package is required for the
application to work, specify that packages in the `DESCRIPTION` file. You can
add a package to the `DESCRIPTION` file by running:

```{r, echo = TRUE, eval = FALSE}
usethis::use_package("dplyr")
```

Alternatively, you can declare the package name and minimum version by running:

```{r, echo = TRUE, eval = FALSE}
usethis::use_package("dplyr", min_version = "0.8.0")
```

The last command appends `dplyr (>= 0.8.0)` under `Imports` in `DESCRIPTION`:

```
Package: project.name
Title: What the Package Does (One Line, Title Case)
Version: 0.0.0.9000
Authors@R: 
    person(given = "First",
           family = "Last",
           role = c("aut", "cre"),
           email = "first.last@example.com",
           comment = c(ORCID = "YOUR-ORCID-ID"))
Description: What the package does (one paragraph).
License: What license it uses
Encoding: UTF-8
LazyData: true
Imports: 
    dplyr (>= 0.8.0)
```

`usethis::use_package` takes care of syntax, duplication and typos (both in
package name and version) for you.

### Adding package requirements outside CRAN

There are two good reasons why one may want to install packages outside CRAN:

1. A particular R package is not available in CRAN, but is available
somewhere else; and
2. A particular R package is available in CRAN, but a specific version is
required.

To install `dplyr` version 0.8.0, from GitHub rather than CRAN, we add it under
the `Remotes` field in the `DESCRIPTION` file. The remote dependencies specified
in Remotes should be described in the following form:

```
Remotes: 
    [type::]<Repository>
```

The `dplyr` package is available on GitHub under `tidyverse/dplyr` repository,
i.e. <https://github.com/tidyverse/dplyr>. Thus, in this case, *type = github*
and *Repository = tidyverse/dplyr*. The DESCRIPTION file becomes:

```
Package: project.name
Title: What the Package Does (One Line, Title Case)
Version: 0.0.0.9000
Authors@R: 
    person(given = "First",
           family = "Last",
           role = c("aut", "cre"),
           email = "first.last@example.com",
           comment = c(ORCID = "YOUR-ORCID-ID"))
Description: What the package does (one paragraph).
License: What license it uses
Encoding: UTF-8
LazyData: true
Imports: 
    dplyr (>= 0.8.0)
Remotes:
    github::tidyverse/dplyr
```

Without specifying more information, the dependency management system pulls
and installs the latest version available in the GitHub Repo (on the master
branch). Instead, we can define a specif git commit to pull and install:

* Installing a specific release: [`github::tidyverse/dplyr@v0.8.0`](https://github.com/tidyverse/dplyr/releases/tag/v0.8.0)
```
Remotes:
    github::tidyverse/dplyr@v0.8.0
```
* Installing a specific commit: [`github::tidyverse/dplyr@f05230dd`](https://github.com/tidyverse/dplyr/tree/f05230dd110a729e95b9ffb86df2030bf3b8b26b)
```
Remotes:
    github::tidyverse/dplyr@f05230dd
```

###	Removing packages requirements

Removing a package from the `DESCRIPTION` file is done manually. Open
`DESCRIPTION` and delete the package name from the `Imports` fields. Make sure
the last package in `Imports` doesn't end with a comma (',').

## Installing Package Requirements

### Emulating CRAN at a specific point in time

Firstly, replicate the package versions that were available at the time of
developing the program. Following this step increases application behaviour
consistency regardless of the date it is executed.

(recommended) You can specify `repos` to point at a snapshot in time of CRAN by
running:

```{r, echo = TRUE, eval = FALSE}
options(repos = "https://mran.microsoft.com/snapshot/2020-03-27")
```

(replace _2020-03-27_ with the date required for reproducibility)

If you skip that step, R installs the latest package versions on the hosting
computer.

### Installing package dependencies

Lastly, Given an R project with a `DESCRIPTION` file in the root folder, when
`remotes::install_deps()` is called, then R tries to install the listed packages
under `Imports` within `DESCRIPTION`.

The following is an extract from the output console:

```
> remotes::install_deps()

Installing packages into '/usr/local/lib/R/site-library'
(as 'lib' is unspecified)

trying URL 'microsoft.com/2020-03-27/src/contrib/dplyr_0.8.5.tar.gz'
Content type 'application/octet-stream' length 3229510 bytes (3.1 MB)
==================================================
downloaded 3.1 MB
```

Notice that `remotes::install_deps`:

* Searches and pulls the `dplyr` package from the `repos` address we have
provided it; and

* Installs `dplyr` version 0.8.5. 
    * While we declared the minimum version to be 0.8.0 in `DESCRIPTION`, the
    available version on 2020-03-27 is 0.8.5.
    * `remotes::install_deps` fails if any declared minimum version is not
    available; otherwise, it installs the latest available version on `repos`.

# Putting Everything Together {#conclusion}

Putting it all together, we get:

```{r conclusion, eval = FALSE, echo = TRUE}
###################################################################
## During project development use this code
###################################################################
# Installing a tool kit for convenience
install.packages(c("remotes", "usethis"))

## Initiating the DESCRIPTION file
usethis::use_description()

## Grooming the DESCRIPTION file
### add {ggplot2} as a requirement
usethis::use_package("ggplot2")
### add {dplyr} version 0.8.0 and above as a requirement
usethis::use_package("dplyr", min_version = "0.8.0") 

###################################################################
## During project deployment use this code
###################################################################
## Emulating CRAN at a specific point in time (27 March 2020)
options(repos = "https://mran.microsoft.com/snapshot/2020-03-27")
## Installing package dependencies
remotes::install_deps()
```

You could try running the code yourself on RStudio Cloud by 
[clicking here](https://rstudio.cloud/project/1179635).

# Reading More About the Subject {#resources}

# References {#references}

