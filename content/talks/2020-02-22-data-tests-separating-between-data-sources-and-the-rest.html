---
title: 'Data Tests: Separating between Data Sources and the Rest'
author: Harel Lustiger
date: '2020-02-22'
slug: data-tests-separating-between-data-sources-and-the-rest
draft: true
categories:
  - R
  - Software Architecture
tags:
  - plugin architecture
  - data sources
  - small design up front
bibliography: [references-talks.bib]
biblio-style: apalike
link-citations: yes  
---

<script src="/rmarkdown-libs/kePrint/kePrint.js"></script>

<div id="TOC">
<ul>
<li><a href="#abstract">Abstract</a></li>
<li><a href="#helping-our-clients-by-fitting-a-solution-to-their-needs">Helping our clients by fitting a solution to their needs</a><ul>
<li><a href="#getting-to-know-our-client">Getting to know our client</a></li>
<li><a href="#the-proposed-solution-is-a-weekly-fact-sheet-with-popular-qa">The proposed solution is a weekly fact sheet with popular Q&amp;A</a></li>
<li><a href="#moving-from-ideation-to-implementation-data-scientists-encounter-real-world">Moving from ideation to implementation, data scientists encounter real-world</a></li>
</ul></li>
<li><a href="#st-iteration-developing-a-data-driven-app-without-real-data">1<sup>st</sup> iteration: developing a data-driven app without real data</a><ul>
<li><a href="#generate-dataset-assumption-triplet">Generate dataset assumption triplet</a></li>
<li><a href="#convert-assumptions-to-assertions-with-data-tests">Convert assumptions to assertions with data-tests</a></li>
<li><a href="#implement-a-data-access-plugin">Implement a data access plugin</a></li>
<li><a href="#develop-an-analytic-application">Develop an analytic application</a></li>
</ul></li>
<li><a href="#why-and-how-we-seperated-the-data-source-from-the-rest">Why and how we seperated the data source from the rest</a><ul>
<li><a href="#recall-why-we-have-separated-the-data-source-from-the-rest">Recall why we have separated the data source from the rest</a></li>
<li><a href="#recall-how-we-have-separated-the-data-source-from-the-rest">Recall how we have separated the data source from the rest</a></li>
</ul></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<div id="abstract" class="section level2">
<h2>Abstract</h2>
<p>Data science projects in commercial companies often experience a challenge
arising from evolving data sources. As the project progresses, new signals and
information sources are added incrementally. In practice, when the data source
changes, it creates a need to change the application source code.</p>
<p>With <strong>no design up front</strong>, some application modules, such as a dashboard or a
machine learning model, unwittingly become dependent on the data source. In this
case, accommodating the evolving data source is not simply a matter of changing
the code related to the data source. Rather, preserving the rest of the existing
application in a working condition involves further code changes in distant
elements of the application.</p>
<p>An alternative way of dealing with evolving data sources is to introduce a
<strong>small design up front</strong>. Such design lets data scientists manage the source
code dependencies throughout the project life-cycle.</p>
<p>This post suggests a design that <mark>(1) separates data sources from analytic
applications and (2) restricts analytic applications from knowing about the data
sources</mark>.</p>
<p>While the evolving data sources challenge is programming language agnostic, this
post demonstrates an implementation of the suggested design in R.</p>
</div>
<div id="helping-our-clients-by-fitting-a-solution-to-their-needs" class="section level2">
<h2>Helping our clients by fitting a solution to their needs</h2>
<div id="getting-to-know-our-client" class="section level3">
<h3>Getting to know our client</h3>
<p>Our client is Euel Cheatam the Merceduce dealership manager.</p>
<p><img src="https://i.imgur.com/IcwSkWa.png" width="100%" style="display: block; margin: auto;" /></p>
<p>Eual has been working in Mercedes dealership as a car salesman for the last 7
years. Today, Eual serves as the dealership manager. His main duty is to ensure
a profitable, complaint, and effective dealership.</p>
<ul>
<li>Eual <strong>thinks</strong> that a professional car salesperson needs to answer prospects
queries quickly and accurately.</li>
<li>Eual <strong>sees</strong> that it takes new hires several months to master the
dealership’s cars specifications. During these months new-hires convert fewer
prospects into clients; this causes new hires to get demotivated; which leads to
fewer sales – it’s a vicious cycle.</li>
<li>Eual <strong>feels</strong> obligated to provide resources that will enable everyone to
succeed as a salesperson, regardless of their work tenure.</li>
<li>Eual <strong>does</strong> not have enough free time slots in his calendar to accommodate
daily mentoring for all the dealership salespeople.</li>
</ul>
</div>
<div id="the-proposed-solution-is-a-weekly-fact-sheet-with-popular-qa" class="section level3">
<h3>The proposed solution is a weekly fact sheet with popular Q&amp;A</h3>
<p><img src="https://i.imgur.com/CMbZ8h7.png" width="100%" style="display: block; margin: auto;" /></p>
<!-- Position Statement -->
<p>For the car salespeople who work at Mercedes dealership, the <em>Factcedes™</em> is a
weekly email service that provides a succinct and readable fact sheet with
popular Q&amp;A about the dealership vehicles. Unlike water cooler talks, our
product has been carefully formulated and evaluated against veterans and is
distributed regularly.</p>
</div>
<div id="moving-from-ideation-to-implementation-data-scientists-encounter-real-world" class="section level3">
<h3>Moving from ideation to implementation, data scientists encounter real-world</h3>
<p>impediments</p>
<p><img src="https://i.imgur.com/TAcOHZO.png" width="100%" style="display: block; margin: auto;" /></p>
<p>Data scientists encounter many 1<sup>st</sup> world problems during the development
process; Unavailable database is one of them. A slow database is another.</p>
</div>
</div>
<div id="st-iteration-developing-a-data-driven-app-without-real-data" class="section level2">
<h2>1<sup>st</sup> iteration: developing a data-driven app without real data</h2>
<div id="generate-dataset-assumption-triplet" class="section level3">
<h3>Generate dataset assumption triplet</h3>
<p>In many cases, including the case in hand, the analytic app can be satisfied
with a tidy data table in its input.</p>
<p>A tidy data table <span class="citation">(Wickham and Grolemund <a href="#ref-wickham2016r" role="doc-biblioref">2016</a>, ch. 12)</span> follows a consistent tabular format
where each variable is a column and each observation is a row.</p>
<p>The data scientist wants the tidy data table to support all of the necessary
variables required by the analytic app, but does not know what all those
variables are. However, the data scientist does know the basic intent of the
analytic app.</p>
<p>Start by making an <strong>assumption triplet</strong> about what information the user needs
to see.</p>
<p>An assumption triplet comprises hypotheses about three variable types that
should be in the tidy data table: <strong>Observation Unique Identifier (UID)</strong>,
<strong>Target variable</strong> and <strong>Salient features</strong>.</p>
<p>In our example,</p>
<ul>
<li><strong>Observation Unique Identifier (UID)</strong> corresponds to car models;</li>
<li><strong>Target variable</strong> is the price; and</li>
<li><strong>Salient features</strong> include gear, and mpg.</li>
</ul>
<!-- tidy data table leaves heavy data wrangling tasks outside the
responsibility of the analytic app. -->
</div>
<div id="convert-assumptions-to-assertions-with-data-tests" class="section level3">
<h3>Convert assumptions to assertions with data-tests</h3>
<ul>
<li>Data-tests are assertions that ensure <a href="https://en.wikipedia.org/wiki/Data_integrity">data
integrity</a>, mainly, they concern
the data existance and structure.</li>
<li>Data tests are like clauses in a contract.</li>
<li>The analytic application dictates the clauses.</li>
<li>The analytic application is dependent only on the clauses.</li>
</ul>
<pre class="r"><code># data-tests.R
## 1. Check if the dataset exists
stopifnot(exist(&quot;cars_data&quot;), is.data.frame(cars_data))
  
## 2. Check if the necessary columns exist
expected_cols &lt;- c(&quot;car_model&quot;, &quot;price&quot;, &quot;gear&quot;, &quot;mpg&quot;)
stopifnot(all(expected_cols %in% colnames(cars_data)))
  
## 3. Check if the records are unique
is.distinct &lt;- function(x) dplyr::n_distinct(x) == length(x)
stopifnot(is.distinct(cars_data$car_model))</code></pre>
</div>
<div id="implement-a-data-access-plugin" class="section level3">
<h3>Implement a data access plugin</h3>
<div id="quick-glimpse-over-the-mtcars-dataset" class="section level4">
<h4>Quick glimpse over the <code>mtcars</code> dataset</h4>
<table class="table table-striped" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-1">Table 1: </span>The first 6 car models from <code>datasets::mtcars</code>
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
mpg
</th>
<th style="text-align:right;">
cyl
</th>
<th style="text-align:right;">
disp
</th>
<th style="text-align:right;">
hp
</th>
<th style="text-align:right;">
drat
</th>
<th style="text-align:right;">
wt
</th>
<th style="text-align:right;">
qsec
</th>
<th style="text-align:right;">
vs
</th>
<th style="text-align:right;">
am
</th>
<th style="text-align:right;">
gear
</th>
<th style="text-align:right;">
carb
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Mazda RX4
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
160
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
Mazda RX4 Wag
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
160
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
Datsun 710
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
108
</td>
<td style="text-align:right;">
93
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Hornet 4 Drive
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
258
</td>
<td style="text-align:right;">
110
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Hornet Sportabout
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
360
</td>
<td style="text-align:right;">
175
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
Valiant
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
225
</td>
<td style="text-align:right;">
105
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
</div>
<div id="generate-synthetic-datasynthetic-data-plugin" class="section level4">
<h4>Generate synthetic data<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> plugin</h4>
<pre class="r"><code>get_cars_data &lt;- function(){
  ## 1. Generate records 
  data(mtcars, package = &quot;datasets&quot;)
  cars_data &lt;- mtcars %&gt;% tibble::rownames_to_column(&quot;car_model&quot;)
  
  ## 2. Generate price
  set.seed(2020)
  price &lt;- runif(n = nrow(cars_data), min = 41, max = 75)
  cars_data &lt;- cars_data %&gt;% tibble::add_column(price = price)
  
  ## Run data-tests
  source(&quot;data-tests.R&quot;)
  return(cars_data)
}</code></pre>
<p>Notice that without conforming to data-tests assertions, the data source does
not come into existence. That means the data source is dependent on data-tests.
Recall that the assertions in data-tests are dictated by the intent of the
analytic app. It is these assertions that know about the analytic app.</p>
</div>
</div>
<div id="develop-an-analytic-application" class="section level3">
<h3>Develop an analytic application</h3>
<pre class="r"><code># app.R
## 1. Get the data
source(&quot;database-access.R&quot;)
cars_data &lt;- get_cars_data()
  
## 2. Render booklet
print(cars_data %&gt;% dplyr::select(car_model, mpg, gear, price))
boxplot(price ~ mpg + gear, cars_data)  </code></pre>
</div>
</div>
<div id="why-and-how-we-seperated-the-data-source-from-the-rest" class="section level2">
<h2>Why and how we seperated the data source from the rest</h2>
<div id="recall-why-we-have-separated-the-data-source-from-the-rest" class="section level3">
<h3>Recall why we have separated the data source from the rest</h3>
<p>Any data-driven application has two essential parts: <em>data source</em> and <em>analytic
app</em>. Importantly, in many applications the data source is indepenet from the
analytic app, but the analytic app is dependent on the data source.</p>
<p>This type of relationship puts the data source at the center of the system. The
analytic applications revolve around the data source. They are plugins of the
data source.</p>
<p>There are two symptoms of such a data-centeric design: change amplification and
cognitive load.</p>
<p>There are two main problems with that.</p>
<ol style="list-style-type: decimal">
<li>Dependecy</li>
<li>Obscurity. It is not obvoius what data in the database is important for the app to run.</li>
</ol>
<p>if one is asked to replace a data source with another implementation, it is not obvious what )</p>
<p>system easy to understand, easy to develop, easy
to maintain, and easy to deploy. The ultimate goal is to minimize the lifetime
cost of the system and to maximize programmer productivity.</p>
<p>The problem is that most of the time the data scientist doesn’t know what all
the variables are</p>
<p>Dependecy and obsquirty</p>
<p>as the system moves through its life cycle.</p>
<p>The database, its query language, and even its schema are technical details
that have nothing to do with the analytic app. They will change at
rates, and for reasons, that are independent of other aspects of the system.
Consequently, the data-tests separate the data source from the rest of the
system so that they can be independently changed.</p>
<p>A good architecture makes the system easy to change, in all the ways that it
must change, by leaving options open.</p>
<p>Introducing the middle layer, data-tests, seperates
There are a few advantages of sepreting the data source from the analytic app:</p>
<p>Develop-ability
Deployability</p>
<p>restand the analytic app are strongly decoupled, the inter
then a team that focuses on the UI cannot much
affect a team that focuses on the business rules</p>
<p>dependencies are clear</p>
<p>Changes in the data source</p>
<p>In practice, the
• programmers can either work on the data source or the analytic app without being exposed to the complexity of the other module.
• make the dependencies that remain as simple and obvious as possible.</p>
<p>The suggested system design:</p>
<ol style="list-style-type: decimal">
<li>Divides and encapsulates those parts into modules;</li>
<li>Separates both parts by introducing an intermediate module dubbed
<em>data-tests</em>; and</li>
<li>Dictates that both parts must depend on the data-tests module.</li>
</ol>
<p>The primary advantage of using data-tests is that <mark>the data source module
and the analytic app module do not know anything of each other</mark>. This
allows those modules to evolve frequently and independently.</p>
</div>
<div id="recall-how-we-have-separated-the-data-source-from-the-rest" class="section level3">
<h3>Recall how we have separated the data source from the rest</h3>
<p>Firstly, we took the analytic app point of view. The app expects a tidy data
table with a specific structure.</p>
<p>Second, we asserted the app expectations regarding the data in the form of a
policy named data-tests.</p>
<p>Third, we implemented a data source that conforms to data-tests.</p>
<!-- ## 2^nd^ iteration: implementing customer feedback -->
<!-- ## 3^rd^ iteration: deploying the application with real data -->
</div>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<!-- Footnotes -->
<div id="refs" class="references">
<div id="ref-wickham2016r">
<p>Wickham, Hadley, and Garrett Grolemund. 2016. <em>R for Data Science: Import, Tidy, Transform, Visualize, and Model Data</em>. " O’Reilly Media, Inc.". <a href="https://r4ds.had.co.nz/">https://r4ds.had.co.nz/</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>A synthetic datasetis contains data that is artificially
created rather than being generated by actual events.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
